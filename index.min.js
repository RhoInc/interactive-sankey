!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("webcharts")):"function"==typeof define&&define.amd?define(["webcharts"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).interactiveSankey=t(e.webCharts)}(this,(function(e){"use strict";"function"!=typeof Object.assign&&(Object.assign=function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var r=arguments[n];if(null!=r)for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])}return t});var t={id_col:"USUBJID",node_col:null,link_col:null,x:{type:"ordinal"},y:{type:"linear"},marks:[{type:"bar",arrange:"stacked",summarizeY:"count",tooltip:"$y at $x"}],legend:{}};function n(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function o(e,t,n){var r=this,o=this,l=[];e.each((function(e,n){t.each((function(t,n){e.values.raw.forEach((function(e){t.values.raw.forEach((function(t){e[o.config.y.column]===t[o.config.y.column]&&l.push({id:e[o.config.y.column],split1:e[o.config.color_by],x1:e[o.config.x.column],split2:t[o.config.color_by],x2:t[o.config.x.column]})}))}))}))}));var a=d3.nest().key((function(e){return e.split1})).key((function(e){return e.split2})).rollup((function(e){return{n:e.length,IDs:e.map((function(e){return e.id}))}})).entries(l);a.sort((function(e,t){return r.config.legend.order.indexOf(e.key)-r.config.legend.order.indexOf(t.key)}));var i=[],c=[];a.forEach((function(n,l){var a=e.data()[0].values.x,s=e.filter((function(e){return e.key===n.key})).data()[0].values,u=0;n.values.sort((function(e,t){return r.config.legend.order.indexOf(e.key)-r.config.legend.order.indexOf(t.key)})),n.values.forEach((function(e){var r=t.data()[0].values.x,l=t.filter((function(t){return t.key===e.key})).data()[0].values;c.push({key:e.key,offset:0});var f=c.filter((function(t){return t.key===e.key}))[0].offset;i.push({split1:n.key,split2:e.key,x1:o.x(a),x2:o.x(r),y1:s.y,y2:l.y,start1:s.start,start2:l.start,stop1:s.start-s.y,stop2:l.start-l.y,y01:s.start-s.y+u,y11:s.start-s.y+e.values.n+u,y02:l.start-l.y+f,y12:l.start-l.y+e.values.n+f,n:e.values.n,height:o.y(e.values.n),IDs:e.values.IDs}),u+=i[i.length-1].n,c.filter((function(t){return t.key===e.key}))[0].offset+=e.values.n}))}));var s=d3.svg.area().x((function(e){return e.x})).y0((function(e){return e.y0})).y1((function(e){return e.y1}));i.forEach((function(e,t){var r=[{split1:e.split1,split2:e.split2,n:e.n,IDs:e.IDs,x:e.x1+o.x.rangeBand(),y0:o.y(e.y01),y1:o.y(e.y11)},{x:e.x2,y0:o.y(e.y02),y1:o.y(e.y12)}];o.svg.append("path").datum(r).attr({d:s,class:"link "+n}).style({fill:function(){return o.colorScale(e.split1)},"fill-opacity":.5,stroke:function(){return o.colorScale(e.split1)},"stroke-opacity":.5})})),d3.selectAll("path.link").on("mouseover",(function(){d3.select(this).style({"fill-opacity":1,"stroke-opacity":1})})).on("mouseout",(function(){d3.select(this).style({"fill-opacity":.5,"stroke-opacity":.5})})).append("title").text((function(e){var t=e[0].n,n=e[0].split1,r=e[0].split2,l=e[0].IDs;return t+" "+o.config.y.column+(t>1?"s ":" ")+(n===r?"remained at "+n:"progressed from "+n+" to "+r)+":\n - "+l.slice(0,3).join("\n - ")+(t>3?"\n - and "+(t-3)+" more":"")}))}var l={onInit:function(){var e=this;this.raw_data=this.raw_data.sort((function(t,n){return t[e.config.node_col]<n[e.config.node_col]?-1:t[e.config.node_col]>n[e.config.node_col]?1:0}));var t=n(new Set(this.raw_data.map((function(t){return t[e.config.link_col]}))).values()).sort();void 0===this.config.legend.order||this.config.legend.order.constructor!==Array?this.config.legend.order=t:t.forEach((function(t){!1===e.config.legend.order.includes(t)&&e.config.legend.order.push(t)}))},onLayout:function(){},onPreprocess:function(){},onDataTransform:function(){},onDraw:function(){},onResize:function(){var e=this;this.wrap.selectAll("path.link").remove(),this.wrap.selectAll(".barAnnotation").remove(),this.makeLegend();var t=d3.set(this.filtered_data.map((function(t){return t[e.config.link_col]}))).values();this.wrap.selectAll(".legend-item").filter((function(){return-1===t.indexOf(d3.select(this).select(".legend-label")[0][0].textContent)})).remove();var n=this.svg.selectAll(".bar-group"),r=n[0].length-1;n.each((function(t,l){var a=t.total;if(d3.select(this).selectAll("rect.wc-data-mark").each((function(t){var n=d3.select(this);n.classed(t.key.replace(/[^a-z0-9]/gi,""),!0);var r=t.values.raw.map((function(t){return t[e.config.id_col]})),o=t.values.raw.length,l=o/e.raw_data.filter((function(n){return n[e.config.node_col]===t.values.x})).length;d3.select(n.node().parentNode).append("text").datum([{node:t.values.x,link:t.key,text:o+" ("+d3.format("%")(l)+")"}]).attr({class:"barAnnotation",x:function(n){return e.x(t.values.x)},y:function(t){return e.y(a)},dx:".25em",dy:".9em"}).text(o+" ("+d3.format("%")(l)+")"),n.select("title").text(o+" "+e.config.id_col+"s at "+t.key+" ("+d3.format("%")(l)+"):\n - "+r.slice(0,3).join("\n - ")+(o>3?"\n - and "+(o-3)+" more":"")),a-=o})),l<r){var i=d3.select(this),c=d3.select(n[0][l+1]);o.call(e,i.selectAll(".bar"),c.selectAll(".bar"),"defaultLink")}}));var l=[];this.current_data.forEach((function(e){e.values.forEach((function(t){l.push({node:e.key,link:t.key,start:t.values.start})}))}));var a=this.wrap.selectAll("rect.wc-data-mark");a.style("cursor","pointer").on("click",(function(t){a.style("fill-opacity",.25),e.wrap.selectAll(".defaultLink").style("display","none"),e.wrap.selectAll(".barAnnotation").style("display","none"),e.wrap.selectAll(".selectedIDs").remove(),e.wrap.selectAll(".selectedLink").remove();var n=t.values.raw.map((function(t){return t[e.config.id_col]})),r=d3.nest().key((function(t){return t[e.config.node_col]})).key((function(t){return t[e.config.link_col]})).rollup((function(e){return e.length})).entries(e.raw_data.filter((function(t){return n.indexOf(t[e.config.id_col])>-1}))),i=[];r.forEach((function(t){t.values.forEach((function(r){return i.push({key:r.key,values:{raw:e.raw_data.filter((function(o){return n.indexOf(o[e.config.id_col])>-1&&o[e.config.node_col].toString()===t.key.toString()&&o[e.config.link_col].toString()===r.key.toString()})),x:t.key,y:r.values,start:l.filter((function(e){return e.node===t.key&&e.link===r.key}))[0].start}})}))}));var c=e.svg.selectAll("rect.selectedIDs").data(i).enter().append("rect").attr({class:"selectedIDs",x:function(t){return e.x(t.values.x)},y:function(t){return e.y(t.values.start)},width:d3.select(this).attr("width"),height:function(t){return e.y(t.values.start-t.values.y)-e.y(t.values.start)}}).style({fill:function(t){return e.colorScale(t.key)},stroke:function(t){return e.colorScale(t.key)}});c.each((function(){d3.select(this).append("title").text((function(t){return t.values.y+" "+e.config.id_col+"s at "+t.values.x+" ("+d3.format("%")(t.values.y/n.length)+"):\n - "+t.values.raw.map((function(t){return t[e.config.id_col]})).slice(0,3).join("\n - ")+(t.values.y>3?"\n - and "+(t.values.y-3)+" more":"")}))})),e.svg.selectAll("text.selectedIDs").data(i).enter().append("text").attr({class:"selectedIDs",x:function(t){return e.x(t.values.x)},y:function(t){return e.y(t.values.start)},dx:".25em",dy:".9em"}).text((function(e){return e.values.y+" ("+d3.format("%")(e.values.y/n.length)+")"}));for(var s=r.map((function(e){return e.key})),u=0;u<s.length;u++)u<s.length-1&&o.call(e,c.filter((function(e){return e.values.x===s[u]})),c.filter((function(e){return e.values.x===s[u+1]})),"selectedLink");c.style("cursor","pointer").on("click",(function(){a.style("fill-opacity",1),c.remove(),e.wrap.selectAll("text.selectedIDs").remove(),e.wrap.selectAll(".selectedLink").remove(),e.wrap.selectAll(".defaultLink").style("display",""),e.wrap.selectAll(".barAnnotation").style("display","")}))}))},onDestroy:function(){}};return function(n,r){var o=function(e){return e.x.column=e.node_col,e.x.label=e.node_col,e.y.column=e.id_col,e.y.label="# of "+e.id_col+"s",e.marks[0].per=[e.node_col],e.marks[0].split=e.link_col,e.color_by=e.link_col,e}(Object.assign({},t,r)),a=e.createChart(n,o);for(var i in l)a.on(i.toLowerCase().substring(2),l[i]);return a}}));
